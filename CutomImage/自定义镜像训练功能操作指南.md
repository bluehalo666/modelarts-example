# 自定义镜像训练功能操作指南

[TOC]

# 1 自定义镜像概述

（1）ModelArts提供了多种预置算法，但是当用户对深度学习引擎、开发库有特殊需求的场景的时候，就需要采用自定义镜像这个功能。自定义镜像支持自由文本形式的命令行参数和环境变量，因此灵活性比较高，便于支持任意计算引擎的作业启动需求。

（2）镜像是指用于运行训练作业的Docker容器镜像，而非宿主机镜像。

（3）华为云官方自定义镜像基础镜像地址：

1. CPU镜像：swr.cn-north-1.myhuaweicloud.com/eiwizard/custom-cpu-base:1.0。

2. GPU镜像：swr.cn-north-1.myhuaweicloud.com/eiwizard/custom-gpu-cuda9-base:1.0。

# 2 构建自定义镜像

## 2.1 自定义镜像制作环境搭建

### 2.1.1 公网自定义镜像环境搭建

（1） apt安装docker，如下以ubuntu16.04 server 64bit为例。

$ sudo apt-get update

$ sudo apt-get install  apt-transport-https 

ca-certificates  curl software-properties-common

\# 添加官方源GPG密钥。

$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

\#向 source.list 中添加 Docker 软件源

$ sudo add-apt-repository  "deb [arch=amd64] https://download.docker.com/linux/ubuntu  $(lsb_release -cs) stable"

\#安装 Docker CE

$ sudo apt-get update

$ sudo apt-get install docker-ce

（2） 启动Docker CE

$ sudo systemctl enable docker

$ sudo systemctl start docker

（3） 建立docker用户组

$ sudo groupadd docker

将当前用户加入 docker 组：

$ sudo usermod -aG docker $USER

（4）获取SWR上的docker login指令并执行       

![1544774327234](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774327234.png)                                           

（5）拉取现网自定义镜像

docker pull swr.cn-north-1.myhuaweicloud.com/eiwizard/custom-cpu-base:1.0

docker pull swr.cn-north-1.myhuaweicloud.com/eiwizard/custom-gpu-cuda9-base:1.0

### 2.1.2 云道自定义镜像环境搭建

（1）申请一台安装了Linux系统的ECS，本次以centos 7.2 64bit为例。

（2） 在此机器上安装docker

1. 配置代理

2. 更新yum缓存 yum makecache

3.  $ yum install -y yum-utils device-mapper-persistent-data  lvm2

4. $ yum makecache fast

  $ curl -fsSL get.docker.com -o get-docker.sh

  $ sudo sh get-docker.sh --mirror Aliyun

（3）启动docker

$ sudo systemctl enable docker

$ sudo systemctl start docker

（4）配置docker代理

$ sudo mkdir -p /etc/systemd/system/docker.service.d

$ vim mkdir -p /etc/systemd/system/docker.service.d/http-proxy.conf

写入http代理

[Service]

Environment="HTTP_PROXY=http://proxy.example.com:80/"

vim mkdir -p /etc/systemd/system/docker.service.d/http-proxy.conf

写入https代理

[Service]

Environment="HTTPS_PROXY=https://proxy.example.com:80/"

（5）重启docker

$ sudo systemctl daemon-reload

$ sudo systemctl restart docker

确认配置生效systemctl show --property=Environment docker

（6）获取云道SWR的docker login 命令并在ECS执行<http://roma.huawei.com/csb/#/cce/hec/warehouse/ZZY010223/mirror/list>

   ![1544774336579](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774336579.png)

（7）配置信任

$ vim /etc/docker/daemon.json

写入

{"insecure-registries": ["swr.cn-north-1.myhuaweicloud.com", "100.125.0.198:20202"] }

（8） 重启docker

$ sudo systemctl daemon-reload

$ sudo systemctl restart docker

（9）拉取现网自定义镜像

$ docker pull swr.cn-north-1.myhuaweicloud.com/eiwizard/custom-cpu-base:1.0

$ docker pull swr.cn-north-1.myhuaweicloud.com/eiwizard/custom-gpu-cuda9-base:1.0

## 2.2 自定义镜像制作

（1） 搭建Docker环境，拉取基础镜像。

（2） 运行容器。

（3）镜像中自带python3、pip3等模块，需要根据自己的需求安装对应的深度学习库及周边自定义模块，比如tensorflow、mxnet等。

（4） 将修改后的容器push到SWR下。

（5） 另外，将必要的数据和训练脚本上传到OBS。上传至OBS，然后通过容器下载，能够使得镜像更加灵活

## 2.3 镜像制作要求

（1）自定义镜像要基于基础镜像来制作。

（2）自定义镜像中无恶意代码。

（3）基础镜像中的部分内容不能改变，包括/bin、/sbin、/usr、/lib(64)下的所有文件，/etc下的部分重要配置文件，以及$HOME下的DLS小工具。

（4）不得新增属主为root且权限包含setuid或setgid位的文件。

# 3 使用自定义镜像创建训练作业介绍

## 3.1 自定义镜像训练创建流程

（1） 用户创建自定义镜像训练作业。

![1544774351880](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774351880.png)

（2）首先后台会先审核镜像，审核失败的原因见于日志，用户根据日志做相应的修改。   

![1544774358986](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774358986.png)

（3） 镜像审核成功后，后台就会开始启动用户自定义镜像容器，开始跑自定义镜像训练作业，用户可根据日志来查看训练情况。   

![1544774365909](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774365909.png)

（4） 其中，用户的自定义镜像会授权于ModelArts；审核成功的镜像再次创建训练作业的时候，不会触发审核；审核失败的镜像再次创建训练作业，会直接报错。

## 3.2 输入参数及环境变量

用户界面如下：   

![1544774378070](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774378070.png)

其中，前台输入的参数会转换为容器的环境变量，各个容器的环境变量如下：

DLS_TASK_INDEX : 当前容器索引，容器从0开始编号。单机训练的时候，该字段无意义。（0）

DLS_TASK_NUMBER：容器总数。（4）

DLS_APP_URL：代码目录。（s3://obs/app/）

DLS_DATA_URL： 数据集位置。（s3://obs/data/）

DLS_TRAIN_URL：训练输出位置。（s3://obs/train/）

BATCH_CUSTOM"$i"_HOSTS：容器网络，容器的ip:port。 （BATCH_CUSTOM0_HOSTS=asdf.ghjj:6666）。一个容器可以看到同一个作业中所有容器的HOSTS，根据索引的不同，分别为BATCH_CUSTOM0_HOSTS、BATCH_CUSTOM1_HOSTS……。                                     

 镜像地址填写镜像的SWR_URL。

![1544774385170](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774385170.png)

## 3.3 自定义镜像运行命令及run_train.sh

(1)  运行命令

​    运行命令为容器启动后，所执行的命令。

运行命令的形式类似：

bash /home/work/run_train.sh  python {python file location} {python file parameter}。

(2)  run_train.sh实现初始化环境和下载DLS_APP_URL中的内容的等功能。

## 3.4 自定义镜像使用的基本方案

为了让用户更加方面的使用自定义镜像功能，用户可以按照如下的方式来使用。

1. 用户不需要修改基础镜像的run_train.sh，用户只需在镜像中添加必要的模块，和上传必要的训练数和脚本据到OBS。
2. run_train.sh会把OBS代码目录（DLS_APP_URL）中的内容下载到容器的/home/work/user-job-dir中，用户可以将要下载的都放在代码目录中；
3. 数据存储位置对应DLS_DATA_URL环境变量，训练输出位置对应DLS_TRAIN_URL环境变量，用户可以根据需求确定自己训练脚本中要不要使用这个环境变量。
4. 运行命令形式为bash /home/work/run_train.sh python /home/work/user-job-dir/{app}/{main.py} {python file parameter}。
5. 对于数据存储位置和训练输出位置可以使用第三点说的环境变量，也可以自己在命令行中输入。比如：一、bash /home/work/run_train.sh python /home/work/user-job-dir/new/mnist/custom_distribution.py --data_url /home/work/user-job-dir/new/mnist_data；二、bash /home/work/run_train.sh python /home/work/user-job-dir/new/mnist/custom_distribution.py --data_url s3://data/test/ --train_url s3://train/test/ --parameter test。
6. 简单的说：为了更方便用自定义镜像，用户只需在镜像中添加必要模块，数据和脚本上传至OBS。容器启动后，会下载代码目录到/home/work/user-job-dir，然后执行用户的python命令。只要运行命令正确，就能调用到用户的训练脚本。

# 4  ModelArts使用自定义镜像创建训练作业配置示例

例子中的，分布式和单机的区别主要在于脚本和运行命令不一样，使用的镜像都为同一个。

例子为mnist训练数据，训练数据用户需要自己去网上下载。mnist_softmax.py为单机脚本。mnist_replica_kill.py为分布式脚本。

## 4.1 单机训练实例

（1）前置条件：

1.下载基础镜像，安装python、boto3等，push到SWR。2.将mnist_softmax.py和训练数据上传至OBS，现将脚本和数据都放在代码目录下，以便直接下载到容器中。

（2）创建自定义镜像训练作业，数据存储位置和训练输出位置用不到，可以随意填写；镜像地址填写刚上传的SWR_URL；运行命令：bash -x /home/work/run_train.sh python /home/work/user-job-dir/new/mnist/mnist_softmax.py --data_url /home/work/user-job-dir/new/mnist_data，其中，“--data_url /home/work/user-job-dir/new/mnist_data”为数据的位置，因为已经把数据放在代码目录中，容器已经下载了代码目录，所以直接使用本地的。

（3）自定义镜像审核成功后，后台会直接执行自定义镜像训练作业。

（4）如此，程序执行成功。

   ![1544774399681](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774399681.png)

## 4.2  分布式训练运行实例

(1)  分布式例子和单机的例子不同的点在于需要改造python文件。对DLS_TASK_INDEX和DLS_TASK_NUMBER进行处理，来适配脚本所需参数，来决定当前容器的功能。当前脚本的功能是将前两个容器作为ps，后两个容器作为worker。   

![1544774407478](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774407478.png)

(2)  其中，运行命令为bash -x /home/work/run_train.sh python /home/work/user-job-dir/new/mnist/mnist_replica_kill.py --data_url /home/work/user-job-dir/new/mnist_data

(3)  节点选多个，其他步骤和单机一样。

(4)  执行结果如下。

![1544774413492](C:\Users\j00416951\AppData\Roaming\Typora\typora-user-images\1544774413492.png)

   